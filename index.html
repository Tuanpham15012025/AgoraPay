<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgoraPay - Test Payment</title>
    <!-- Pi Web SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  </head>
  <body>
    <h2>AgoraPay Test</h2>
    <button id="testPaymentBtn">ğŸ’³ Test Payment 1Ï€</button>
    <pre id="result"></pre>

    <script>
      // Cáº¥u hÃ¬nh app cá»§a báº¡n (thay báº±ng App ID thá»±c táº¿ trÃªn Pi Developer Portal)
      const APP_ID = "agorapay"; 

      // HÃ m log ra mÃ n hÃ¬nh
      function log(msg) {
        document.getElementById("result").innerText += msg + "\n";
      }

      // Khi báº¥m nÃºt "Test Payment"
      document.getElementById("testPaymentBtn").addEventListener("click", async () => {
        try {
          // ÄÄƒng nháº­p trÆ°á»›c Ä‘á»ƒ láº¥y thÃ´ng tin user
          const scopes = ['username', 'payments'];
          const authResult = await window.Pi.authenticate(scopes, APP_ID);
          log("âœ… Auth success: " + JSON.stringify(authResult));

          // Táº¡o payment request
          const paymentData = {
            amount: 1,
            memo: "Test payment 1Ï€ via AgoraPay",
            metadata: { type: "test" }
          };

          log("ğŸ“¤ Creating payment...");

          // Gá»i Pi SDK Ä‘á»ƒ táº¡o payment
          const payment = await window.Pi.createPayment(paymentData, {
            onReadyForServerApproval: async (paymentId) => {
              log("â³ Ready for server approval: " + paymentId);
              await fetch("/api/create-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId })
              });
            },
            onReadyForServerCompletion: async (paymentId, txid) => {
              log("â³ Ready for server completion: " + paymentId + " txid: " + txid);
              await fetch("/api/complete-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId, txid })
              });
            },
            onCancel: (paymentId) => {
              log("âŒ Payment cancelled: " + paymentId);
            },
            onError: (error, payment) => {
              log("âš ï¸ Payment error: " + error + " payment: " + JSON.stringify(payment));
            },
          });

          log("âœ… Payment created: " + JSON.stringify(payment));
        } catch (err) {
          log("âŒ Error: " + err.message);
        }
      });
    </script>
  </body>
</html>
